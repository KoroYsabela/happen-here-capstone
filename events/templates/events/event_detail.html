{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}

<div class="masthead">
  <div class="container">
    <div class="row g-0">
      <div class="col-12 col-md-6 masthead-text mt-1 order-2 order-md-1">
        <!-- Event title goes in these h1 tags -->
        <h1 class="event-title">{{ event.title }}</h1>
        <p class="event-subtitle">Hosted by {{ event.host }}</p>
        <hr>
        <p><i class="fa-solid fa-calendar-days"></i> {{ event.date }}</p>
        <p><i class="fa-solid fa-location-dot"></i> {{ event.location }}</p>
        <p class="event-subtitle"><i class="fa-solid fa-people-group"></i> <strong>Spaces left: </strong>{{ event.capacity}}</p>
        <hr>                
        <div id="capacity">
          <!-- Capacity left -->
          <!-- Dont allow booking or cancel booking if the event date has already passed --> 
          {% if event.date < now %}
          <div id="capacity-details">
            <p>This event has already past.<p>
          </div> 
          {% else %}
          <div id="capacity-details">            
            {% if user.is_authenticated %}
              {% if user_booking %}
                <p>You have a space for this event.</p>
                <button 
                    type="button" 
                    class="btn btn-outline-danger cancel-trigger" 
                    data-bs-toggle="modal" 
                    data-bs-target="#cancelEventFormModal"
                    data-booking-id="{{ user_booking.id }}"
                    data-slug="{{ event.slug }}">
                    Cancel Booking
                  </button>
              {% else %}
                <!-- Book event form -->
                <form method="POST" action="{% url 'book_event' event.slug %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-success" {% if event.capacity <= 0 %}disabled{% endif %}>
                    {% if event.capacity > 0 %}
                      Book
                    {% else %}
                      Fully Booked
                    {% endif %}
                  </button>
                </form>
              {% endif %}
            {% else %}
              <p class="text-muted">Please <a href="{% url 'account_login' %}">Log in</a> to book.</p>
            {% endif %}    
          </div>
          {% endif %} 
        </div>
        <div id="edit-details">
          <!-- Edit event if user is host -->
          {% if user.is_authenticated and event.host == user %}
            <hr> 
            <div id="btnsConatiner">
              <button 
                class="btn btn-outline-secondary edit-btn" 
                data-bs-toggle="modal" 
                data-bs-target="#editEventFormModal"
                data-title="{{ event.title }}"
                data-date="{{ event.date|date:'Y-m-d\\TH:i' }}"
                data-capacity="{{ event.capacity }}"
                data-location="{{ event.location }}"
                data-description="{{ event.description|escapejs }}"
                data-slug="{{ event.slug }}"
                data-status="{{ event.status }}"
                >
                Edit
              </button>
              <button 
                class="btn btn-outline-danger delete-event-btn" 
                data-bs-toggle="modal" 
                data-bs-target="#deleteEventFormModal"
                data-title="{{ event.title }}"
                data-slug="{{ event.slug }}"
                >
                Delete
              </button>                        
            </div>
          {% endif %}            
        </div>                           
      </div>
        <div class="col-12 col-md-6 masthead-image mt-md-3 order-1 order-md-2 align-self-center">
          <div class="image-container mx-3">
              {% if "placeholder" in event.featured_image.url %}
              <img class="img-fluid w-100" src="{% static 'images/event_default.jpg' %}"
              alt="placeholder image">
              {% else %}
              <img class="img-fluid w-100" src=" {{ event.featured_image.url }}" alt="{{ event.title }}">
              {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Event descrtiption -->
<div class="container">
    <div class="row">
        <div class="col card mb-4  mt-3 left  top">
            <div class="card-body">
                <article class="card-text">
                    {{ event.description | safe }}
                </article>
            </div>
        </div>
    </div>
</div>

<!-- Edit event modal -->
<div class="modal fade" id="editEventFormModal" tabindex="-1" role="dialog" aria-labelledby="edit-event-modal-title" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
    <form method="POST" enctype="multipart/form-data" action="{% url 'edit_event' event.slug %}">
        <input type="hidden" name="event_slug" id="eventSlugInput">                   
        <div class="modal-header">
          <h5 class="modal-title" id="edit-event-modal-title">Editing: {{ event.title }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {# Render the edit form with crispy so widgets and classes are output properly #}
          {{ edit_form | crispy }}
          {{ edit_form.media }} 
          {% csrf_token %} 
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" name="save_draft" class="btn btn-outline-warning d-none" id="saveDraftBtn">Save as Draft</button>
          <button type="submit" name="publish" class="btn btn-success">Publish</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete event modal -->
<div class="modal fade" id="deleteEventFormModal" tabindex="-1" role="dialog" aria-labelledby="delete-event-modal-title" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
  <form method="POST" action="{% url 'delete_event' event.slug %}">
    <input type="hidden" name="event_slug_delete" id="eventDeleteSlugInput">                   
        <div class="modal-header">
          <h5 class="modal-title" id="delete-event-modal-title">Deleting Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        {% csrf_token %} 
          <p>Are you sure you want to delete the event:<br><strong id="deleteEventName">{{ event.title }}</strong>?</p>
          <p class="text-muted mb-0">This action cannot be undone.</p> 
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" name="publish" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Cancel event modal -->
<div class="modal fade" id="cancelEventFormModal" tabindex="-1" role="dialog" aria-labelledby="cancel-event-modal-title" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="cancelEventBookingForm" method="POST" action="{% if user_booking %}{% url 'cancel_event' event.slug user_booking.id %}{% else %}#{% endif %}">
        <input type="hidden" name="event_slug_cancel" id="eventCancelSlugInput">                   
            <div class="modal-header">
              <h5 class="modal-title" id="cancel-event-modal-title">Cancel booking</h5>
              <button type="button" class="btn-close cancel-booking-btn" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            {% csrf_token %} 
              <p>Are you sure you want to cancel your booking for the event:<br><strong id="cancelEventName">{{ event.title }}</strong>?</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, keep the booking</button>
              <button type="submit" name="publish" class="btn btn-danger cancel-event-booking-btn">Yes, Cancel</button>
            </div>
      </form>
    </div>
  </div>
</div>


<!-- event_detail.html content ends here -->
{% endblock %}
